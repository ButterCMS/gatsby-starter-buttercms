{"version":3,"sources":["../../src/utils/babel-loader-helpers.js"],"names":["path","require","_","loadCachedConfig","pluginBabelConfig","stages","test","plugins","presets","process","env","NODE_ENV","join","cwd","getCustomOptions","stage","options","prepareOptions","babel","resolve","requiredPlugins","createConfigItem","staticQueryDir","type","requiredPresets","push","GATSBY_HOT_LOADER","fallbackPresets","reduxPlugins","reduxPresets","forEach","plugin","name","preset","mergeConfigItemOptions","items","itemToMerge","index","findIndex","i","file","resolved","merge","exports"],"mappings":"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","sourcesContent":["const path = require(`path`)\nconst _ = require(`lodash`)\n\nconst loadCachedConfig = () => {\n  let pluginBabelConfig = {\n    stages: {\n      test: { plugins: [], presets: [] },\n    },\n  }\n  if (process.env.NODE_ENV !== `test`) {\n    pluginBabelConfig = require(path.join(\n      process.cwd(),\n      `./.cache/babelState.json`\n    ))\n  }\n  return pluginBabelConfig\n}\n\nconst getCustomOptions = stage => {\n  const pluginBabelConfig = loadCachedConfig()\n  return pluginBabelConfig.stages[stage].options\n}\n\nconst prepareOptions = (babel, options = {}, resolve = require.resolve) => {\n  const pluginBabelConfig = loadCachedConfig()\n\n  const { stage } = options\n\n  // Required plugins/presets\n  const requiredPlugins = [\n    babel.createConfigItem(\n      [\n        resolve(`babel-plugin-remove-graphql-queries`),\n        { stage, staticQueryDir: `page-data/sq/d` },\n      ],\n      {\n        type: `plugin`,\n      }\n    ),\n  ]\n  const requiredPresets = []\n\n  // Stage specific plugins to add\n  if (stage === `build-html` || stage === `develop-html`) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`babel-plugin-dynamic-import-node`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  // TODO: Remove entire block when we make fast-refresh the default\n  if (stage === `develop` && process.env.GATSBY_HOT_LOADER !== `fast-refresh`) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`react-hot-loader/babel`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  // Fallback preset\n  const fallbackPresets = []\n\n  fallbackPresets.push(\n    babel.createConfigItem(\n      [\n        resolve(`babel-preset-gatsby`),\n        {\n          stage,\n        },\n      ],\n      {\n        type: `preset`,\n      }\n    )\n  )\n\n  // Go through babel state and create config items for presets/plugins from.\n  const reduxPlugins = []\n  const reduxPresets = []\n  pluginBabelConfig.stages[stage].plugins.forEach(plugin => {\n    reduxPlugins.push(\n      babel.createConfigItem([resolve(plugin.name), plugin.options], {\n        name: plugin.name,\n        type: `plugin`,\n      })\n    )\n  })\n  pluginBabelConfig.stages[stage].presets.forEach(preset => {\n    reduxPresets.push(\n      babel.createConfigItem([resolve(preset.name), preset.options], {\n        name: preset.name,\n        type: `preset`,\n      })\n    )\n  })\n\n  return [\n    reduxPresets,\n    reduxPlugins,\n    requiredPresets,\n    requiredPlugins,\n    fallbackPresets,\n  ]\n}\n\nconst mergeConfigItemOptions = ({ items, itemToMerge, type, babel }) => {\n  const index = _.findIndex(\n    items,\n    i => i.file.resolved === itemToMerge.file.resolved\n  )\n\n  // If this exist, merge the options, otherwise, add it to the array\n  if (index !== -1) {\n    items[index] = babel.createConfigItem(\n      [\n        itemToMerge.file.resolved,\n        _.merge({}, items[index].options, itemToMerge.options),\n      ],\n      {\n        type,\n      }\n    )\n  } else {\n    items.push(itemToMerge)\n  }\n\n  return items\n}\n\nexports.getCustomOptions = getCustomOptions\n\n// Export helper functions for testing\nexports.prepareOptions = prepareOptions\nexports.mergeConfigItemOptions = mergeConfigItemOptions\n"],"file":"babel-loader-helpers.js"}